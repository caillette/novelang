<?xml version="1.0"?>

<project basedir="." name="Novelang build file" >

  <description>
    Build system for Novelang.

    Novelang is a lightweight authoring tool for writing novels.
    
    Ant-1.7.0 required. Use other version at your own risk!
    
    ------------------------------------

    Copyright (C) 2006 Laurent Caillette

    This program is free software; you can redistribute it and/or
    modify it under the terms of the GNU Lesser General Public
    License as published by the Free Software Foundation; either
    version 2 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
    Lesser General Public License for more details.

    You should have received a copy of the GNU Lesser General Public
    License along with this program; if not, write to the Free Software
    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

  </description>
  
  <target name="init" >
  
    <pathconvert property="basedir.fullpath" dirsep="/" >      
      <path>
        <pathelement location="${basedir}" />
      </path>
    </pathconvert>
    <echo>basedir.fullpath = ${basedir.fullpath}</echo>
    
    <tstamp>
      <format property="timestamp" pattern="yyyy-MM-dd_HH.mm" />
    </tstamp>

    <!-- Overrides any property defined in build.properties -->
    <property file="${user.home}/novelang.build.properties" />
    
    <property file="build.properties" />

    <patternset id="resource-patterns" >
      <include name="**/*.properties" />
      <include name="**/*.xml" />
      <include name="**/*.png" />
      <include name="**/*.jpeg" />
      <include name="**/*.jpg" />
      <include name="**/*.gif" />
      <include name="**/*.css" />      
      <include name="**/*.html" />
      <include name="**/*.xhtml" />
      <include name="**/*.dtd" />
      <include name="**/*.txt" />
      <include name="**/*.bin" />
      <include name="**/*.st" />
    </patternset>

    <path id="deploy-libs" >
      <fileset dir="${lib.deploy.dir}" includes="*.jar" />
    </path>

    <path id="build-libs" >
      <fileset dir="${lib.build.dir}" includes="*.jar" />
    </path>

    <path id="antlr-grammars" >
      <fileset dir="${source.main.antlr.dir}" includes="*.g"/>
    </path>

    <path id="antlr-gunit" >
      <fileset dir="${source.test.antlr.dir}" includes="*.gunit"/>
    </path>

  </target>

  
  <target name="target-dir" depends="init" >
    <mkdir dir="${target.dir}" />
    <mkdir dir="${target.mainclasses.dir}" />
  </target>


  <target name="clean" depends="init" >
    <delete dir="${target.dir}" />  
  </target>
  
  
  <!--
    =======
    Compile
    =======  
  -->

  <target name="antlr-generate-main" depends="init, target-dir" >

    <pathconvert
        refid="antlr-grammars"
        property="antlr-main-sources"
        dirsep="/"
        pathsep=" "
    >
      <map from="${basedir.fullpath}/" to="" /> <!-- Needed, really? -->
    </pathconvert>

    <echo>antlrsources='${antlr-main-sources}'</echo>

    <java
        classname="org.antlr.Tool"
        failonerror="true"
    >
      <classpath refid="build-libs" />
      <arg line="-fo ${target.antlr.generated.main.dir} ${antlr-main-sources}" />
    </java>

  </target>


  <target name="antlr-test" depends="init, target-dir, main-compile" description="GUnit tests" >

    <pathconvert
        refid="antlr-gunit"
        property="antlr-test-sources"
        dirsep="/"
        pathsep=" "
    >
      <map from="${basedir.fullpath}/" to="" /> <!-- Needed, really? -->
    </pathconvert>

    <echo>antlrsources='${antlr-test-sources}'</echo>

    <!-- Use a wrapper for running several GUnit suites at once. -->
    <java
        classname="novelang.gunit.Launcher"
        failonerror="true"
    >
      <classpath>
        <path refid="build-libs" />
        <pathelement path="${target.mainclasses.dir}" />

      </classpath>
      <arg line="${antlr-test-sources}" />
    </java>

  </target>


  <target name="main-compile" depends="init, target-dir, antlr-generate-main" >

    <javac 
        destdir="${target.mainclasses.dir}"
        source="${compiler.source}"
        target="${compiler.target}"
        debug="on"
        debuglevel="lines,vars,source"
    >
      <classpath>
        <path refid="deploy-libs" />
      </classpath>
      <src path="${source.main.java.dir}" />
      <src path="${target.antlr.generated.main.dir}" />
    </javac>
    
    <copy todir="${target.mainclasses.dir}" >
      <fileset dir="${source.main.java.dir}" >
        <patternset refid="resource-patterns" />
      </fileset>
      <fileset dir="${configuration.main.dir}" >
        <patternset refid="resource-patterns" />
      </fileset>
    </copy>
    
  </target>


  <target name="test-compile" depends="main-compile, antlr-test" >
    
    <mkdir dir="${target.testclasses.dir}" />    

    <javac
        destdir="${target.testclasses.dir}"
        srcdir="${source.test.java.dir}"
        source="${compiler.source}"
        target="${compiler.target}"
    >
      <classpath>
        <path refid="deploy-libs" />
        <path refid="build-libs" />
        <pathelement path="${target.mainclasses.dir}" />
      </classpath>
    </javac>

    <copy todir="${target.testclasses.dir}" >
      <fileset dir="${source.test.java.dir}" >
        <patternset refid="resource-patterns" />
      </fileset>
      <fileset dir="${configuration.test.dir}" >
        <patternset refid="resource-patterns" />
      </fileset>
    </copy>
    
  </target>
  
  
  
  <!--
    ====
    Test
    ====  
  -->  

  <target name="test" depends="init, target-dir" >

    <delete dir="${target.testreports.dir}" />
    <mkdir dir="${target.testreports.dir}" />    

    <junit printsummary="yes" haltonfailure="no" >
      <classpath>
        <path refid="build-libs" />
        <path refid="deploy-libs" />
        <pathelement location="${target.mainclasses.dir}" />
        <pathelement location="${target.testclasses.dir}" />
        <pathelement location="${source.samples.dir}" />
      </classpath>
      <batchtest fork="yes" todir="${target.testreports.dir}" >
        <fileset 
            dir="${target.testclasses.dir}" 
            includes="**/*Test.class"
            excludes="**/Abstract*Test.class"
        />
      </batchtest>
      <formatter type="plain"/>
    </junit>
  </target>
  

  <!--
    ===================
    Start / stop server
    ===================
  -->

  <target name="start-httpd" depends="init" >
    
    <loadfile
        srcfile="${novelang.httpd.books}"
        property="books"
        failonerror="true"
    >
      <!-- TODO replace line breaks by spaces -->
    </loadfile>

    <echoproperties/>

    <java
        classname="novelang.jetty.ServerMain"
        failonerror="true"
        fork="true"
    >
      <classpath>
        <path refid="deploy-libs" />
        <pathelement location="${target.mainclasses.dir}" />
        <pathelement location="${configuration.main.dir}" />
      </classpath>
      <arg line="${books}" />
      <jvmarg value="-Duser.dir=${user.dir}" /> <!-- Override Ant's basedir -->
      <jvmarg value="-Dfile.encoding=${novelang.encoding}" />
      <jvmarg value="-Dnovelang.styles.dir=${source.style.dir}" />
      <jvmarg value="-Xmx512M" />
    </java>

  </target>

</project>